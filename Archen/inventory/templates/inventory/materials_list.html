<!-- PATH: /Archen/inventory/templates/inventory/materials_list.html -->
{% extends 'layout.html' %}

{% load static %}
{% block title %}لیست مواد اولیه | صنایع چوبی آرچن{% endblock %}
{% block page_title %}لیست مواد اولیه{% endblock %}
{% block back_button %}
  <a href="{% url 'inventory:dashboard' %}"
     class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-blue-600 text-blue-700 hover:bg-blue-200">بازگشت</a>
{% endblock %}

{% block Breadcrumb %}
<!-- Breadcrumb -->
<div class="my-2 px-2 text-sm text-gray-600 rtl text-right breadcrumb">
  <a href="{% url 'dashboard' %}" class="hover:underline">داشبورد</a>
  <span class="mx-1">›</span>
  <a href="{% url 'inventory:dashboard' %}" class="hover:underline">انبار</a>
  <span class="mx-1">›</span>
  <span class="text-gray-800 font-semibold">لیست مواد اولیه</span>
</div>
{% endblock %}
{# Toolbar content is provided via layout.html. Avoid extra wrappers here. #}

    {% block list_toolbar_actions_right %}
      <a href="{% url 'inventory:materials_add' %}" class="flex-none inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-green-700 text-green-700 hover:bg-green-200">
        <svg class="w-4 h-4 ms-0 me-1 text-green-800" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        افزودن
      </a>
      <form id="bulkForm" method="post" action="{% url 'inventory:materials_bulk_delete' %}" class="flex-none">{% csrf_token %}
        <button id="bulkDeleteBtn" type="submit" class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-red-700 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <svg class="w-4 h-4 ms-0 me-1 text-red-700" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 3h6a1 1 0 0 1 1 1v1h3v2H5V5h3V4a1 1 0 0 1 1-1zm-2 6h10v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9zm2 2v8h2v-8H9zm4 0v8h2v-8h-2z"/></svg>
          حذف
        </button>
    </form>
    {% endblock %}
    {% block list_toolbar_filters %}
      <a id="materials_export_xlsx_btn"
         href="{% url 'inventory:materials_export_xlsx' %}"
         data-base="{% url 'inventory:materials_export_xlsx' %}"
         title="خروجی XLSX"
         class="flex-none inline-flex items-center h-8 px-3 text-xs whitespace-nowrap rounded border font-bold border-green-700 text-green-700 hover:bg-green-200 shrink-0">
        خروجی XLSX
      </a>
      <label for="searchInput" class="sr-only">جستجو</label>
      <input id="searchInput" name="search" value="{{ search_query }}" placeholder="جستجو..." class="flex-1 min-w-0 max-w-full border border-gray-300 px-2 py-1 rounded text-sm bg-white me-1" onkeydown="if(event.key==='Enter')this.form.submit()">
    {% endblock %}
    {% block list_status %}مواد اولیه: {{ materials|length }} | کمبود موجودی: <span id="belowCounter">—</span>{% endblock %}

{% block content %}
    <!-- Use header-like patterned surface for the list frame -->
    <div class="overflow-x-auto surface-pattern surface-elevated rounded-xl p-2">
      <!-- Prevent word wrapping on mobile; restore normal on >=sm -->
      <table id="materialsTable" class="table-auto border border-gray-300 w-full whitespace-nowrap sm:whitespace-normal">
        <thead class="bg-gray-100">
          <tr class="text-xs sm:text-sm">
            <th class="p-2 border text-center">
              <label for="selectAll" class="sr-only">انتخاب همه</label>
              <input type="checkbox" id="selectAll" aria-label="انتخاب همه">
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="1" onclick="sortByCol(this, 'materialsTable')">
                نام ماده
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="2" data-type="num" onclick="sortByCol(this, 'materialsTable')">
                مقدار
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="3" onclick="sortByCol(this, 'materialsTable')">
                واحد
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="4" onclick="sortByCol(this, 'materialsTable')">
                تأمین‌کننده
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="5" data-type="num" onclick="sortByCol(this, 'materialsTable')">
                قیمت
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for item in materials %}
          {% with qty=item.quantity|default_if_none:0 thr=item.threshold|default_if_none:0 %}
          <tr class="text-center border-b" data-qty="{{ qty }}" data-thr="{{ thr }}">
            <td class="p-2 border"><input type="checkbox" form="bulkForm" name="selected_items" value="{{ item.id }}"></td>
            <td class="p-0 border text-right nowrap">
              <a href="{% url 'inventory:materials_edit' item.pk %}" class="block w-full h-full px-2 py-2 text-black hover:bg-cyan-300 focus:bg-cyan-300 rounded transition-colors duration-100 text-sm truncate-ellipsis">{{ item.name }}</a>
            </td>
            <td class="p-2 border">{# Show integer 0 when quantity is zero; otherwise show as-is. Treat qty <= threshold as shortage (red). #}{% if qty <= thr %}<span class="font-bold text-red-700" title="آستانه: {{ thr }}">{% if qty == 0 %}0{% else %}{{ qty }}{% endif %}</span>{% else %}<span class="font-bold text-green-700" title="آستانه: {{ thr }}">{% if qty == 0 %}0{% else %}{{ qty }}{% endif %}</span>{% endif %}</td>
            <td class="p-2 border">{{ item.unit }}</td>
            <td class="p-2 border">{{ item.supplier }}</td>
            <td class="p-2 border"><span class="font-bold">{# Hide price when it's 0 or None. #}{% if item.price %}{{ item.price }}{% endif %}</span></td>
          </tr>
          {% endwith %}
          {% empty %}
          <tr><td colspan="6" class="p-4 text-center text-gray-500">موردی یافت نشد.</td></tr>
          {% endfor %}
        </tbody>
      </table>
  </div>
  <!-- Strongen table borders and emphasize numeric values -->
  <style>
      /* Stronger borders for better legibility */
      #materialsTable, #materialsTable th, #materialsTable td {
        border-color: rgba(0,0,0,0.38) !important;
        border-width: 1.5px;
      }
      #materialsTable thead th { border-bottom-width: 2px; }
  </style>

  <script>
    // Keep XLSX export link aligned with current search query
    document.addEventListener('DOMContentLoaded', function(){
      const exportBtn = document.getElementById('materials_export_xlsx_btn');
      if (!exportBtn) return;
      const baseHref = exportBtn.getAttribute('data-base') || exportBtn.getAttribute('href') || '';
      function updateExportHref(){
        if (!baseHref) return;
        const params = new URLSearchParams();
        const searchInput = document.getElementById('searchInput');
        if (searchInput && searchInput.value) params.set('search', (searchInput.value || '').trim());
        const qs = params.toString();
        exportBtn.href = qs ? (baseHref + '?' + qs) : baseHref;
      }
      updateExportHref();
      const searchInput = document.getElementById('searchInput');
      if (searchInput) searchInput.addEventListener('input', updateExportHref);
    });
  </script>

  <script>
    // Initialize server-side shortage counter immediately for consistency with backend logic
    (function(){
      try {
        var el = document.getElementById('belowCounter');
        if (el) { el.textContent = String({{ below_threshold_count|default:0 }}); }
      } catch (e) { /* no-op */ }
    })();
  </script>
{# Keep list/table content only; no extra toolbar containers. #}

<script>
  // Live search
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const q = (searchInput.value || '').toLowerCase();
      document.querySelectorAll('#materialsTable tbody tr').forEach(row => {
        const txt = row.textContent.toLowerCase();
        row.style.display = txt.includes(q) ? '' : 'none';
      });
      updateBelowCounter();
      updateDeleteState();
    });
  }

  // Select-all + bulk delete state
  const selectAll = document.getElementById("selectAll");
  function updateDeleteState() {
    const any = !!document.querySelector('#materialsTable tbody input[name="selected_items"]:checked');
    const btn = document.getElementById("bulkDeleteBtn");
    if (btn) btn.disabled = !any;
  }
  if (selectAll) {
    selectAll.addEventListener("click", function () {
      document.querySelectorAll('#materialsTable tbody input[name="selected_items"]').forEach(cb => cb.checked = this.checked);
      updateDeleteState();
    });
  }
  document.addEventListener('change', e => {
    if (e.target && e.target.name === 'selected_items') updateDeleteState();
  });
  updateDeleteState();

  // Below-threshold counter (only visible rows)
  function updateBelowCounter() {
    const rows = Array.from(document.querySelectorAll('#materialsTable tbody tr')).filter(r => r.style.display !== 'none');
    let below = 0;
    rows.forEach(r => {
      const qty = Number(r.getAttribute('data-qty') || 0);
      const thr = Number(r.getAttribute('data-thr') || 0);
      // Treat quantity at or below threshold as shortage
      if (qty <= thr) below += 1;
    });
    const el = document.getElementById('belowCounter');
    if (el) el.textContent = String(below);
  }
  document.addEventListener('DOMContentLoaded', updateBelowCounter);

  // Simple sorter
  function sortByCol(btn, tableId) {
    const colIdx = parseInt(btn.getAttribute('data-col'), 10);
    const type = btn.getAttribute('data-type') || 'str';
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const asc = !(btn.dataset.asc === 'true');
    btn.dataset.asc = asc ? 'true' : 'false';
    const val = (cell) => (cell || '').trim().toLowerCase();
    rows.sort((a, b) => {
      let ta = a.children[colIdx]?.innerText || '';
      let tb = b.children[colIdx]?.innerText || '';
      if (type === 'num') { ta = parseFloat(ta.replace(/[^\d.-]/g,'')) || 0; tb = parseFloat(tb.replace(/[^\d.-]/g,'')) || 0; return asc ? ta - tb : tb - ta; }
      return asc ? (val(ta) < val(tb) ? -1 : val(ta) > val(tb) ? 1 : 0) : (val(ta) > val(tb) ? -1 : val(ta) < val(tb) ? 1 : 0);
    });
    rows.forEach(r => tbody.appendChild(r));
  }
</script>
{% endblock %}

