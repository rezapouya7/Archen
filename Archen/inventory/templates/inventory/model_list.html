{% extends 'layout.html' %}
{% load static %}
{% block title %}لیست مدل‌ها | صنایع چوبی آرچن{% endblock %}
{% block page_title %}لیست مدل‌ها{% endblock %}

{% block back_button %}
  <a href="{% url 'inventory:dashboard' %}"
     class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-blue-600 text-blue-700 hover:bg-blue-200">
    بازگشت
  </a>
{% endblock %}
{% block Breadcrumb %}
<!-- Breadcrumb -->
<div class="my-2 px-2 text-sm text-gray-600 rtl text-right breadcrumb">
  <a href="{% url 'dashboard' %}" class="hover:underline">داشبورد</a>
  <span class="mx-1">›</span>
  <a href="{% url 'inventory:dashboard' %}" class="hover:underline">انبار</a>
  <span class="mx-1">›</span>
  <span class="text-gray-800 font-semibold">لیست مدل‌ها</span>
</div>
{% endblock %}
{# Toolbar is rendered by layout.html; avoid wrapping containers here. #}
    {% block list_toolbar_actions_right %}
      <a href="{% url 'inventory:model_create' %}" class="flex-none inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-green-700 text-green-700 hover:bg-green-200">
        <svg class="w-4 h-4 ms-0 me-1 text-green-800" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        افزودن
      </a>
      <form id="bulkForm" method="post" action="{% url 'inventory:model_bulk_delete' %}" class="flex-none">
        {% csrf_token %}
        <button id="bulkDeleteBtn" type="submit" class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-red-700 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <svg class="w-4 h-4 ms-0 me-1 text-red-700" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 3h6a1 1 0 0 1 1 1v1h3v2H5V5h3V4a1 1 0 0 1 1-1zm-2 6h10v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9zm2 2v8h2v-8H9zm4 0v8h2v-8h-2z"/></svg>
          حذف
        </button>
      </form>
    {% endblock %}
    {% block list_toolbar_filters %}
      <label for="searchInput" class="sr-only">جستجو</label>
      <input id="searchInput" type="text" name="search" value="{{ search_query }}" placeholder="جستجو در مدل‌ها..." class="flex-1 min-w-24 max-w-full border border-gray-300 p-2 rounded text-sm me-1" onkeydown="if(event.key==='Enter')this.form.submit()">
    {% endblock %}
    {% block list_status %}مدل‌ها: {{ models|length }}{% endblock %}
{% block content %}
    <!-- TABLE on patterned surface matching headers -->
    <div class="overflow-x-auto surface-pattern surface-elevated rounded-xl p-2">
      <!-- Prevent word wrapping on mobile; restore normal on >=sm -->
      <table id="modelTable" class="min-w-full border border-gray-200 whitespace-nowrap sm:whitespace-normal">
        <thead class="bg-gray-50">
          <tr class="text-xs sm:text-sm">
            <th class="p-2 border text-center">
              <label for="selectAllModels" class="sr-only">انتخاب همه</label>
              <input type="checkbox" id="selectAllModels" aria-label="انتخاب همه">
            </th>
            <!-- name (col 1) -->
            <th class="p-2 border text-center">
              <button type="button"
                      class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                      data-col="1" onclick="sortByCol(this, 'modelTable')">
                نام مدل
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <!-- description (col 2) -->
            <th class="p-2 border text-center">
              <button type="button"
                      class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                      data-col="2" onclick="sortByCol(this, 'modelTable')">
                توضیحات
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for m in models %}
          <tr class="text-center border-b">
            <td class="p-2 border">
              <input type="checkbox" form="bulkForm" name="selected_models" value="{{ m.id }}" aria-label="انتخاب مدل {{ m.name }}">
            </td>
            <td class="p-0 border text-right">
              <a href="{% url 'inventory:model_edit' m.id %}"
                 class="block w-full h-full px-2 py-2 text-black hover:bg-cyan-300 focus:bg-cyan-300 rounded transition-colors duration-100 text-sm">
                {{ m.name }}
              </a>
            </td>
            <td class="p-2 border text-right">{{ m.description|default_if_none:'' }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="3" class="p-4 text-center text-gray-500">مدلی یافت نشد.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Strongen table borders to match other lists -->
    <style>
      /* Stronger borders for better legibility */
      #modelTable, #modelTable th, #modelTable td {
        border-color: rgba(0,0,0,0.38) !important;
        border-width: 1.5px;
      }
      #modelTable thead th { border-bottom-width: 2px; }
    </style>
{# Keep only table/list content in this block. #}

<script>
  // Local live filter
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const q = (searchInput.value || '').toLowerCase();
      document.querySelectorAll('#modelTable tbody tr').forEach(row => {
        const txt = row.textContent.toLowerCase();
        row.style.display = txt.includes(q) ? '' : 'none';
      });
      updateDeleteState('modelTable', 'bulkDeleteBtn', 'selected_models');
    });
  }

  function updateDeleteState(tableId, btnId, checkboxName) {
    const any = !!document.querySelector('#' + tableId + ' tbody input[name="' + checkboxName + '"]:checked');
    const btn = document.getElementById(btnId);
    if (btn) btn.disabled = !any;
  }
  const selectAllModels = document.getElementById('selectAllModels');
  if (selectAllModels) {
    selectAllModels.addEventListener('click', function () {
      document.querySelectorAll('#modelTable tbody input[name="selected_models"]').forEach(cb => cb.checked = this.checked);
      updateDeleteState('modelTable', 'bulkDeleteBtn', 'selected_models');
    });
  }
  document.addEventListener('change', e => {
    if (e.target && e.target.name === 'selected_models') updateDeleteState('modelTable', 'bulkDeleteBtn', 'selected_models');
  });
  updateDeleteState('modelTable', 'bulkDeleteBtn', 'selected_models');

  function sortByCol(btn, tableId) {
    const colIdx = parseInt(btn.getAttribute('data-col'), 10);
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.querySelector('td'));
    const asc = !(btn.dataset.asc === 'true');
    btn.dataset.asc = asc ? 'true' : 'false';
    rows.sort((a, b) => {
      const ta = (a.children[colIdx]?.innerText || '').trim().toLowerCase();
      const tb = (b.children[colIdx]?.innerText || '').trim().toLowerCase();
      if (ta < tb) return asc ? -1 : 1;
      if (ta > tb) return asc ? 1 : -1;
      return 0;
    });
    rows.forEach(r => tbody.appendChild(r));
  }
</script>
{% endblock %}
