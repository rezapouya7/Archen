<!-- PATH: /Archen/production_line/templates/production_line/section_dashboard.html -->
{% extends 'layout.html' %}
{% load static %}

{% block title %}نمودار فعالیت {{ section_label }} | صنایع چوبی آرچن{% endblock %}
{% block page_title %}نمودار فعالیت {{ section_label }}{% endblock %}

{% block back_button %}
  <a href="{{ back_url }}"
     class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-blue-600 text-blue-700 hover:bg-blue-200">بازگشت</a>
{% endblock %}
{% block Breadcrumb %}
<!-- Breadcrumb navigation -->
<div class="mb-3 text-sm text-gray-600 rtl text-right">
  <a href="{% url 'dashboard' %}" class="hover:underline">داشبورد</a>
  <span class="mx-1">›</span>
  <a href="{% url 'production_line:index' %}" class="hover:underline">خط تولید</a>
  {% if parent_unit_name %}
    <span class="mx-1">›</span>
    {# Link back to the parent unit using the computed back_url #}
    <a href="{{ back_url }}" class="hover:underline">{{ parent_unit_name }}</a>
  {% endif %}
  <span class="mx-1">›</span>
  <span class="text-gray-800 font-semibold">نمودار فعالیت {{ section_label }}</span>
</div>
{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto p-4 bg-white/60 rounded-xl shadow-none border border-gray-200/60">
  <style>
    /* Ensure YYYY-MM-DD renders left-to-right inside RTL tables.
       Using isolate prevents bidi merging with surrounding RTL text. */
    .num-ltr { direction: ltr; unicode-bidi: isolate; display: inline-block; }
  </style>

  <!-- Period selector for chart: daily, weekly, monthly, yearly -->
  <div class="mb-4 flex flex-wrap gap-2 justify-start items-center">
    <a href="?period=daily"
       class="px-3 py-1 rounded-full text-sm {% if selected_period == 'daily' %}border border-green-700 text-green-700 hover:bg-green-200{% else %}border border-gray-300 text-gray-700 hover:bg-gray-200{% endif %}">
      روزانه
    </a>
    <a href="?period=weekly"
       class="px-3 py-1 rounded-full text-sm {% if selected_period == 'weekly' %}border border-green-700 text-green-700 hover:bg-green-200{% else %}border border-gray-300 text-gray-700 hover:bg-gray-200{% endif %}">
      هفتگی
    </a>
    <a href="?period=monthly"
       class="px-3 py-1 rounded-full text-sm {% if selected_period == 'monthly' %}border border-green-700 text-green-700 hover:bg-green-200{% else %}border border-gray-300 text-gray-700 hover:bg-gray-200{% endif %}">
      ماهانه
    </a>
    <a href="?period=yearly"
       class="px-3 py-1 rounded-full text-sm {% if selected_period == 'yearly' %}border border-green-700 text-green-700 hover:bg-green-200{% else %}border border-gray-300 text-gray-700 hover:bg-gray-200{% endif %}">
      سالانه
    </a>
  </div>

  <canvas id="chart" class="w-full h-64"></canvas>
  <div class="mt-6 flex items-center justify-between">
    <h3 class="font-bold">ثبت‌های اخیر</h3>
  </div>
  <div class="mt-3 overflow-x-auto">
    <!-- Ensure no text wrapping on mobile; allow horizontal scroll -->
    <table class="min-w-full text-sm whitespace-nowrap sm:whitespace-normal">
      <thead class="bg-gray-50 text-gray-700">
        <tr>
          <th class="px-3 py-2 text-right">تاریخ</th>
          <th class="px-3 py-2 text-right">ساعت</th>
          <th class="px-3 py-2 text-right">مدل</th>
          <th class="px-3 py-2 text-right">{{ name_column_label }}</th>
          <th class="px-3 py-2 text-right">تولید</th>
          <th class="px-3 py-2 text-right">{{ scrap_column_label }}</th>
          <th class="px-3 py-2 text-right">کاربر</th>
          <th class="px-3 py-2 text-right">توضیح</th>
        </tr>
      </thead>
      <tbody>
        {% for row in today_logs %}
        <tr class="border-b last:border-b-0">
          <td class="px-3 py-2"><span class="num-ltr">{{ row.date }}</span></td>
          <td class="px-3 py-2"><span class="num-ltr">{{ row.time }}</span></td>
          <td class="px-3 py-2">{{ row.model }}</td>
          <td class="px-3 py-2">{{ row.name }}</td>
          <td class="px-3 py-2 font-medium text-emerald-700">{{ row.produced }}</td>
          <td class="px-3 py-2 font-medium text-rose-700">{{ row.scrap }}</td>
          <td class="px-3 py-2">{{ row.user }}</td>
          <td class="px-3 py-2">{{ row.note }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="px-3 py-4 text-center text-gray-500">موردی ثبت نشده است.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

<script src="{% static 'js/chart.lite.v2.js' %}?v=20251016"></script>
<script>

(function() {
  const points = {{ points|safe }};
  const labels = points.map(p => (p.label || p.jdate));
  const produced = points.map(p => p.produced || 0);
  const scrap = points.map(p => -(p.scrap || 0));

  const canvas = document.getElementById('chart');
  const ctx = canvas.getContext('2d');
  const __chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'تولید', data: produced, backgroundColor: '#22c55e' },
        { label: '{{ scrap_column_label }}', data: scrap, backgroundColor: '#ef4444' },
      ]
    },
    options: {
      responsive: true,
      darkTheme: true,
      legend: true,
      animationDuration: 700,
      highlightIndex: {{ highlight_index|default:'-1' }},
      // Pass selected period for mobile tilt in weekly/monthly
      period: '{{ selected_period }}'
    }
  });
  try { if (window.ArchenCharts) window.ArchenCharts.register('pl-section-chart', __chart); } catch(_){}
})();
</script>
{% endblock %}
