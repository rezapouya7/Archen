<!-- PATH: /Archen/inventory/templates/inventory/products_form.html -->
{% extends "layout.html" %}
{% load static %}
{% load static widget_tweaks %}
{# -------- Page <title> -------- #}
{% block title %}
  {% if is_editing %}ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„{% else %}Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„{% endif %} | ØµÙ†Ø§ÛŒØ¹ Ú†ÙˆØ¨ÛŒ Ø¢Ø±Ú†Ù†
{% endblock %}
{# -------- Page header (H1) -------- #}
{% block page_title %}
  {% if is_editing %}ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„{% else %}Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„{% endif %}
{% endblock %}
{# -------- Back button area from base layout -------- #}
{% block back_button %}
  <a href="{% url 'inventory:products_list' %}"
     class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-blue-600 text-blue-700 hover:bg-blue-200">
    Ø¨Ø§Ø²Ú¯Ø´Øª
  </a>
{% endblock %}
{% block Breadcrumb %} 
<!-- Breadcrumb navigation -->
<div class="mb-3 text-sm text-gray-600 rtl text-right">
  <a href="{% url 'dashboard' %}" class="hover:underline">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
  <span class="mx-1">â€º</span>
  <a href="{% url 'inventory:dashboard' %}" class="hover:underline">Ø§Ù†Ø¨Ø§Ø±</a>
  <span class="mx-1">â€º</span>
  <a href="{% url 'inventory:products_list' %}" class="hover:underline">Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª</a>
  <span class="mx-1">â€º</span>
  <span class="text-gray-800 font-semibold">{% if is_editing %}ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø­ØµÙˆÙ„{% else %}Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØµÙˆÙ„{% endif %}</span>
</div>
{% endblock %}
{% block content %}
<div class="py-4 font-sans rtl text-right max-w-3xl mx-auto">
  <!-- Use patterned, elevated surface consistent with the main header -->
  <div class="w-full max-w-xl mx-auto surface-pattern surface-elevated p-6 rounded-xl">

        {# Prevent native browser validation messages (English) #}
        <form id="productForm" method="post" novalidate class="grid grid-cols-1 gap-4">
          {% csrf_token %}

          {% if form.non_field_errors %}
            <div class="text-red-600 text-sm space-y-1">
              {% for err in form.non_field_errors %}<p>{{ err }}</p>{% endfor %}
            </div>
          {% endif %}

          {# Product name * #}
          <div class="flex flex-col">
            <!-- Bolden input labels per UI guideline -->
            <label for="{{ form.name.id_for_label }}" class="text-sm text-gray-700 mb-1 font-bold">
              {{ form.name.label }}{% if form.name.field.required %}<span class="text-red-600">*</span>{% endif %}
            </label>
            {{ form.name|add_class:'w-full border border-gray-300 p-2 rounded text-sm' }}
            {% if form.name.help_text %}<p class="text-xs text-gray-500 mt-1">{{ form.name.help_text }}</p>{% endif %}
            {% if form.name.errors %}
              <div class="text-xs text-red-600 mt-1">{% for e in form.name.errors %}<p>{{ e }}</p>{% endfor %}</div>
            {% endif %}
          </div>

          {# Product model * #}
          <div class="flex flex-col">
            <label for="{{ form.product_model.id_for_label }}" class="text-sm text-gray-700 mb-1 font-bold">
              {{ form.product_model.label }}{% if form.product_model.field.required %}<span class="text-red-600">*</span>{% endif %}
            </label>
            {{ form.product_model|add_class:'w-full border border-gray-300 p-2 rounded text-sm' }}
            {% if form.product_model.help_text %}<p class="text-xs text-gray-500 mt-1">{{ form.product_model.help_text }}</p>{% endif %}
            {% if form.product_model.errors %}
              <div class="text-xs text-red-600 mt-1">{% for e in form.product_model.errors %}<p>{{ e }}</p>{% endfor %}</div>
            {% endif %}
          </div>

          {# Description #}
          <div class="flex flex-col">
            <label for="{{ form.description.id_for_label }}" class="text-sm text-gray-700 mb-1 font-bold">
              {{ form.description.label }}{% if form.description.field.required %}<span class="text-red-600">*</span>{% endif %}
            </label>
            {{ form.description|add_class:'w-full border border-gray-300 p-2 rounded text-sm' }}
            {% if form.description.help_text %}<p class="text-xs text-gray-500 mt-1">{{ form.description.help_text }}</p>{% endif %}
            {% if form.description.errors %}
              <div class="text-xs text-red-600 mt-1">{% for e in form.description.errors %}<p>{{ e }}</p>{% endfor %}</div>
            {% endif %}
          </div>

          {# Stock threshold (optional) #}
          <div class="flex flex-col">
            <label for="{{ form.threshold.id_for_label }}" class="text-sm text-gray-700 mb-1 font-bold">
              {{ form.threshold.label }}{% if form.threshold.field.required %}<span class="text-red-600">*</span>{% endif %}
            </label>
            {{ form.threshold|add_class:'w-full border border-gray-300 p-2 rounded text-sm' }}
            {% if form.threshold.help_text %}<p class="text-xs text-gray-500 mt-1">{{ form.threshold.help_text }}</p>{% endif %}
            {% if form.threshold.errors %}
              <div class="text-xs text-red-600 mt-1">{% for e in form.threshold.errors %}<p>{{ e }}</p>{% endfor %}</div>
            {% endif %}
          </div>
          <!-- Render hidden BOM fields (components_data & materials_data).  These
               inputs will be populated by the clientâ€‘side script as the user
               adds or edits rows. -->
          {{ form.components_data }}
          {{ form.materials_data }}

          <!-- Components table -->
          <div id="components-section" class="flex flex-col gap-2 mt-4 overflow-x-auto">
            <h3 class="text-sm font-bold text-gray-700">Ù‚Ø·Ø¹Ø§Øª ØªØ´Ú©ÛŒÙ„â€ŒØ¯Ù‡Ù†Ø¯Ù‡</h3>
            <!-- Prevent word wrapping on mobile; restore normal on >=sm -->
            <table id="componentsTable" class="w-full text-sm text-gray-800 border border-gray-200 rounded whitespace-nowrap sm:whitespace-normal">
              <thead class="bg-gray-50">
                <tr class="text-center">
                  <th class="p-2 border w-1/2">Ù‚Ø·Ø¹Ù‡</th>
                  <th class="p-2 border w-24">ØªØ¹Ø¯Ø§Ø¯</th>
                  <th class="p-2 border w-16">Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be inserted by JavaScript -->
              </tbody>
            </table>
            <button type="button" id="addComponentBtn" class="mt-2 self-start inline-flex items-center gap-1 px-2 py-1 text-sm font-bold rounded border border-green-700 text-green-700 hover:bg-green-200 transition whitespace-nowrap">
              <svg class="w-4 h-4 ms-0 me-1 text-green-800" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Ø§ÙØ²ÙˆØ¯Ù† Ù‚Ø·Ø¹Ù‡
            </button>
          </div>

          <!-- Materials table -->
          <div id="materials-section" class="flex flex-col gap-2 mt-6 overflow-x-auto">
            <h3 class="text-sm font-bold text-gray-700">Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ ØªØ´Ú©ÛŒÙ„â€ŒØ¯Ù‡Ù†Ø¯Ù‡</h3>
            <!-- Prevent word wrapping on mobile; restore normal on >=sm -->
            <table id="materialsTable" class="w-full text-sm text-gray-800 border border-gray-200 rounded whitespace-nowrap sm:whitespace-normal">
              <thead class="bg-gray-50">
                <tr class="text-center">
                  <th class="p-2 border w-1/2">Ù…Ø§Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ‡</th>
                  <th class="p-2 border w-24">Ù…Ù‚Ø¯Ø§Ø±</th>
                  <th class="p-2 border w-16">Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody>
                <!-- Rows will be inserted by JavaScript -->
              </tbody>
            </table>
            <button type="button" id="addMaterialBtn" class="mt-2 self-start inline-flex items-center gap-1 px-2 py-1 text-sm font-bold rounded border border-green-700 text-green-700 hover:bg-green-200 transition whitespace-nowrap">
              <svg class="w-4 h-4 ms-0 me-1 text-green-800" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ø¯Ù‡ Ø§ÙˆÙ„ÛŒÙ‡
            </button>
          </div>

          {# Actions #}
          <div class="flex flex-col sm:flex-row gap-4 pt-6 justify-between">
            <a href="{% url 'inventory:products_list' %}"
               class="w-full sm:w-1/2 px-4 py-2 rounded text-sm font-semibold text-center border border-red-700 text-red-700 hover:bg-red-200 transition">
              Ø§Ù†ØµØ±Ø§Ù
            </a>
            <button type="submit"
                    class="w-full sm:w-1/2 px-4 py-2 rounded text-sm font-semibold text-center border border-green-700 text-green-700 hover:bg-green-200 transition">
              {% if is_editing %}Ø°Ø®ÛŒØ±Ù‡{% else %}Ø§ÛŒØ¬Ø§Ø¯{% endif %}
            </button>
          </div>
        </form>

      </div>
    </div>

    <script>
      // Disable duplicate submissions and trim the description field on submit.
      (function () {
        const form = document.getElementById('productForm');
        if (!form) return;
        const saveBtn = form.querySelector('button[type="submit"]');
        form.addEventListener('submit', function () {
          try {
            const desc = document.getElementById('{{ form.description.id_for_label }}') || document.getElementById('id_description');
            if (desc && typeof desc.value === 'string') desc.value = desc.value.trim();
          } catch (e) {}
          if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
          }
          // Before submission, ensure BOM data is serialized into the hidden fields
          try {
            syncComponentsData();
            syncMaterialsData();
          } catch (e) {}
        });
      })();

      // ----------------------
      // Dynamic BOM editor
      // ----------------------
      (function(){
        // Parse the JSON context variables embedded by the view.  These
        // objects map model names to arrays of parts or provide flat lists
        // of materials.  When editing an existing product, the
        // ``initialComponents`` and ``initialMaterials`` arrays contain
        // the currently defined BOM rows.
        const partsByModel = {{ parts_json|safe }};
        const materialsList = {{ materials_json|safe }};
        const initialComponents = {{ initial_components_json|safe }};
        const initialMaterials = {{ initial_materials_json|safe }};

        const modelSelect = document.getElementById('id_product_model');
        const componentsTableBody = document.querySelector('#componentsTable tbody');
        const materialsTableBody = document.querySelector('#materialsTable tbody');
        const addComponentBtn = document.getElementById('addComponentBtn');
        const addMaterialBtn = document.getElementById('addMaterialBtn');
        const componentsDataInput = document.getElementById('id_components_data');
        const materialsDataInput = document.getElementById('id_materials_data');

        // Helper to get current model name (use selected option label, not value)
        function currentModel() {
          if (!modelSelect) return '';
          const opt = modelSelect.options[modelSelect.selectedIndex];
          return opt ? (opt.textContent || '').trim() : '';
        }

        // Build an options fragment for parts belonging to the current model.
        function buildPartOptions(selectedId) {
          const model = currentModel();
          const opts = partsByModel[model] || [];
          const frag = document.createDocumentFragment();
          opts.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.name;
            if (String(item.id) === String(selectedId)) opt.selected = true;
            frag.appendChild(opt);
          });
          return frag;
        }

        // Build an options fragment for all materials.
        function buildMaterialOptions(selectedId) {
          const frag = document.createDocumentFragment();
          materialsList.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.name + (item.unit ? ` \u200e(${item.unit})` : '');
            if (String(item.id) === String(selectedId)) opt.selected = true;
            frag.appendChild(opt);
          });
          return frag;
        }

        // Create a component table row.  Accepts optional data object with
        // ``part_id`` and ``qty`` properties.
        function createComponentRow(data) {
          const row = document.createElement('tr');
          row.className = 'text-center';
          const tdSelect = document.createElement('td');
          tdSelect.className = 'p-2 border';
          const select = document.createElement('select');
          select.className = 'w-full border border-gray-300 p-1 rounded text-sm bg-white';
          tdSelect.appendChild(select);
          const tdQty = document.createElement('td');
          tdQty.className = 'p-2 border';
          const qtyInput = document.createElement('input');
          qtyInput.type = 'number';
          qtyInput.min = '1';
          qtyInput.step = '1';
          qtyInput.value = data && data.qty ? data.qty : '';
          qtyInput.className = 'w-full border border-gray-300 p-1 rounded text-sm text-center ltr';
          tdQty.appendChild(qtyInput);
          const tdDel = document.createElement('td');
          tdDel.className = 'p-2 border';
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          // Use a trash can glyph for deletion and provide a title for accessibility
          delBtn.textContent = 'ğŸ—‘';
          delBtn.title = 'Ø­Ø°Ù';
          delBtn.className = 'inline-flex items-center justify-center text-red-600 hover:text-red-700 px-2 py-0.5';
          // Ensure icon is a red trash SVG (avoid emoji color issues)
          delBtn.innerHTML = '<svg class="w-4 h-4 text-red-600" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 3h6a1 1 0 0 1 1 1v1h3v2H5V5h3V4a1 1 0 0 1 1-1zm-2 6h10v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9zm2 2v8h2v-8H9zm4 0v8h2v-8h-2z"/></svg>';
          delBtn.title = 'Ø­Ø°Ù';
          delBtn.setAttribute('aria-label','Ø­Ø°Ù');
          tdDel.appendChild(delBtn);
          row.appendChild(tdSelect);
          row.appendChild(tdQty);
          row.appendChild(tdDel);

          // Populate part options based on current model.  If no parts exist,
          // insert a disabled placeholder option and disable the select and
          // quantity input.  Otherwise, ensure the inputs are enabled.
          function updatePartOptions() {
            const model = currentModel();
            const opts = partsByModel[model] || [];
            const prevVal = select.value;
            select.innerHTML = '';
            if (opts.length === 0) {
              // No parts for selected model: show placeholder and disable inputs
              const opt = document.createElement('option');
              opt.disabled = true;
              opt.selected = true;
              opt.textContent = 'Ø§Ø¨ØªØ¯Ø§ Ù…Ø¯Ù„ Ø­Ø§ÙˆÛŒ Ù‚Ø·Ø¹Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯';
              select.appendChild(opt);
              select.disabled = true;
              qtyInput.disabled = true;
            } else {
              opts.forEach(item => {
                const optEl = document.createElement('option');
                optEl.value = item.id;
                optEl.textContent = item.name;
                select.appendChild(optEl);
              });
              // Determine which option to select: prefer current selection if still valid,
              // otherwise fall back to initial data.part_id if provided, otherwise first item.
              let selectedVal = '';
              if (prevVal && opts.some(p => String(p.id) === String(prevVal))) {
                selectedVal = String(prevVal);
              } else if (data && data.part_id && opts.some(p => String(p.id) === String(data.part_id))) {
                selectedVal = String(data.part_id);
              }
              if (selectedVal) {
                select.value = selectedVal;
              } else {
                select.selectedIndex = 0;
              }
              select.disabled = false;
              qtyInput.disabled = false;
              if (!qtyInput.value) qtyInput.value = '1';
            }
          }
          updatePartOptions();


          if (modelSelect) {
            modelSelect.addEventListener('change', () => {
              updatePartOptions();
              syncComponentsData();
            });
          }

          select.addEventListener('change', syncComponentsData);
          qtyInput.addEventListener('input', syncComponentsData);
          // Delete row handler
          delBtn.addEventListener('click', () => {
            row.remove();
            syncComponentsData();
          });
          return row;
        }

        // Create a material table row.  Accepts optional data with
        // ``material_id`` and ``qty``.
        function createMaterialRow(data) {
          const row = document.createElement('tr');
          row.className = 'text-center';
          const tdSelect = document.createElement('td');
          tdSelect.className = 'p-2 border';
          const select = document.createElement('select');
          select.className = 'w-full border border-gray-300 p-1 rounded text-sm bg-white';
          tdSelect.appendChild(select);
          const tdQty = document.createElement('td');
          tdQty.className = 'p-2 border';
          const qtyInput = document.createElement('input');
          qtyInput.type = 'number';
          qtyInput.min = '0.001';
          qtyInput.step = '0.001';
          qtyInput.value = data && data.qty ? data.qty : '';
          qtyInput.className = 'w-full border border-gray-300 p-1 rounded text-sm text-center ltr';
          tdQty.appendChild(qtyInput);
          const tdDel = document.createElement('td');
          tdDel.className = 'p-2 border';
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.textContent = 'ğŸ—‘';
          delBtn.title = 'Ø­Ø°Ù';
          delBtn.className = 'inline-flex items-center justify-center text-red-600 hover:text-red-700 px-2 py-0.5';
          // Ensure icon is a red trash SVG (avoid emoji color issues)
          delBtn.innerHTML = '<svg class="w-4 h-4 text-red-600" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 3h6a1 1 0 0 1 1 1v1h3v2H5V5h3V4a1 1 0 0 1 1-1zm-2 6h10v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9zm2 2v8h2v-8H9zm4 0v8h2v-8h-2z"/></svg>';
          delBtn.title = 'Ø­Ø°Ù';
          delBtn.setAttribute('aria-label','Ø­Ø°Ù');
          tdDel.appendChild(delBtn);
          row.appendChild(tdSelect);
          row.appendChild(tdQty);
          row.appendChild(tdDel);

          // Populate material options; if none exist, add a disabled placeholder and disable inputs
          function updateMaterialOptions() {
            select.innerHTML = '';
            if (!materialsList || materialsList.length === 0) {
              const opt = document.createElement('option');
              opt.disabled = true;
              opt.selected = true;
              opt.textContent = 'Ø§Ø¨ØªØ¯Ø§ Ù…ÙˆØ§Ø¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ ØªØ¹Ø±ÛŒÙ Ú©Ù†ÛŒØ¯';
              select.appendChild(opt);
              select.disabled = true;
              qtyInput.disabled = true;
            } else {
              materialsList.forEach(item => {
                const optEl = document.createElement('option');
                optEl.value = item.id;
                optEl.textContent = item.name + (item.unit ? ` \u200e(${item.unit})` : '');
                select.appendChild(optEl);
              });
              // Try to select the provided material_id if valid
              if (data && data.material_id) {
                const match = materialsList.find(m => String(m.id) === String(data.material_id));
                if (match) select.value = String(match.id);
              }
              select.disabled = false;
              qtyInput.disabled = false;
              if (!qtyInput.value) qtyInput.value = '1';
            }
          }
          updateMaterialOptions();

          select.addEventListener('change', syncMaterialsData);
          qtyInput.addEventListener('input', syncMaterialsData);
          delBtn.addEventListener('click', () => {
            row.remove();
            syncMaterialsData();
          });
          return row;
        }

        // Serialize component rows into the hidden input.  Each entry is an
        // object {part_id, qty}.  Only rows with a valid part selected and a
        // positive quantity are included.  Duplicate part_ids will be
        // overwritten by the last occurrence.
        window.syncComponentsData = function() {
          const out = [];
          const rows = componentsTableBody.querySelectorAll('tr');
          rows.forEach(row => {
            const select = row.querySelector('select');
            const qtyInput = row.querySelector('input[type="number"]');
            const pid = select && select.value;
            const qty = qtyInput && qtyInput.value;
            if (pid && qty && parseFloat(qty) > 0) {
              out.push({ part_id: parseInt(pid, 10), qty: parseInt(qty, 10) });
            }
          });
          if (componentsDataInput) componentsDataInput.value = JSON.stringify(out);
        };

        // Serialize material rows into the hidden input.  Each entry is an
        // object {material_id, qty}.  Quantities are kept as strings to
        // preserve decimal precision.
        window.syncMaterialsData = function() {
          const out = [];
          const rows = materialsTableBody.querySelectorAll('tr');
          rows.forEach(row => {
            const select = row.querySelector('select');
            const qtyInput = row.querySelector('input[type="number"]');
            const mid = select && select.value;
            const qty = qtyInput && qtyInput.value;
            // Accept any positive decimal quantity
            if (mid && qty && parseFloat(qty) > 0) {
              out.push({ material_id: parseInt(mid, 10), qty: qty });
            }
          });
          if (materialsDataInput) materialsDataInput.value = JSON.stringify(out);
        };

        // Initialise tables with any preexisting rows (edit mode).
        function initTables() {
          // Populate any existing BOM rows (edit mode)
          if (initialComponents && Array.isArray(initialComponents)) {
            initialComponents.forEach(item => {
              const r = createComponentRow(item);
              componentsTableBody.appendChild(r);
            });
          }
          if (initialMaterials && Array.isArray(initialMaterials)) {
            initialMaterials.forEach(item => {
              const r = createMaterialRow(item);
              materialsTableBody.appendChild(r);
            });
          }
          // Do not insert default rows; leave tables empty until user adds rows.
          syncComponentsData();
          syncMaterialsData();
        }

        // Add new rows on button clicks
        if (addComponentBtn) {
          addComponentBtn.addEventListener('click', () => {
            componentsTableBody.appendChild(createComponentRow(null));
            syncComponentsData();
          });
        }
        if (addMaterialBtn) {
          addMaterialBtn.addEventListener('click', () => {
            materialsTableBody.appendChild(createMaterialRow(null));
            syncMaterialsData();
          });
        }

        // Initialise on page load
        initTables();
      })();
    </script>
    <script>
      // English: Auto-select numeric values on focus in Products form.
      document.addEventListener('DOMContentLoaded', function () {
        var form = document.getElementById('productForm');
        if (!form) return;
        var inputs = form.querySelectorAll('input[type="number"]');
        inputs.forEach(function (el) {
          el.addEventListener('focus', function () {
            try {
              setTimeout(function () {
                if (el.select) {
                  el.select();
                }
              }, 0);
            } catch (_) {
              // noop
            }
          });
        });
      });
    </script>

  </div>
</div>
{% endblock %}
