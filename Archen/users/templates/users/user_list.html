<!-- PATH: /Archen/users/templates/users/user_list.html -->
{% extends 'layout.html' %}

{% load static %}
{% block title %}لیست کاربران | صنایع چوبی آرچن{% endblock %}
{% block page_title %}لیست کاربران{% endblock %}
{% block back_button %}
  <a href="{% url 'dashboard' %}" class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-blue-600 text-blue-700 hover:bg-blue-200">بازگشت</a>
{% endblock %}

{% block Breadcrumb %}
<!-- Breadcrumb -->
<div class="my-2 px-2 text-sm text-gray-600 rtl text-right breadcrumb">
  <a href="{% url 'dashboard' %}" class="hover:underline">داشبورد</a>
  <span class="mx-1">›</span>
  <span class="text-gray-800 font-semibold">لیست کاربران</span>
</div>
{% endblock %}
{# Use global toolbar from layout; remove local wrappers. #}

    {% block list_toolbar_actions_right %}
      <a href="{% url 'users:user_add' %}" class="flex-none inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-green-700 text-green-700 hover:bg-green-200">
        <svg class="w-4 h-4 ms-0 me-1 text-green-800" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        افزودن
      </a>
      <form id="bulkForm" method="post" action="{% url 'users:bulk_delete' %}" class="flex-none">{% csrf_token %}
        <button id="bulkDeleteBtn" type="submit" class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-red-700 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <svg class="w-4 h-4 ms-0 me-1 text-red-700" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 3h6a1 1 0 0 1 1 1v1h3v2H5V5h3V4a1 1 0 0 1 1-1zm-2 6h10v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9zm2 2v8h2v-8H9zm4 0v8h2v-8h-2z"/></svg>
          حذف
        </button>
      </form>
    {% endblock %}
    {% block list_toolbar_filters %}
      <a id="users_export_xlsx_btn"
         href="{% url 'users:export_xlsx' %}"
         data-base="{% url 'users:export_xlsx' %}"
         title="خروجی XLSX"
         class="flex-none inline-flex items-center h-8 px-3 text-xs whitespace-nowrap rounded border font-bold border-green-700 text-green-700 hover:bg-green-200 shrink-0">
        خروجی XLSX
      </a>
      <label for="roleFilter" class="sr-only">نقش</label>
      <select id="roleFilter" name="role" class="flex-none w-44 border border-gray-300 p-2 rounded text-sm bg-white" onchange="this.form.submit()" {% if not users or role_choices|length <= 0 %}disabled{% endif %}>
        <option value="">همه نقش‌ها</option>
        {% for key, value in role_choices %}
          <option value="{{ key }}" {% if current_role == key %}selected{% endif %}>{{ value }}</option>
        {% endfor %}
      </select>
      <label for="searchInput" class="sr-only">جستجو</label>
      <input id="searchInput" type="text" name="search" value="{{ search_query }}" placeholder="جستجو..." class="flex-1 min-w-0 max-w-full border border-gray-300 p-2 rounded text-sm me-1" onkeydown="if(event.key==='Enter')this.form.submit()">
    {% endblock %}
    {% block list_status %}کاربران: {{ users|length }} | فعال: {{ active_users_count }}{% endblock %}
{% block content %}
    <!-- Use header-like patterned surface for the list frame -->
    <div class="overflow-x-auto surface-pattern surface-elevated rounded-xl p-2">
      <table id="userTable" class="min-w-full border border-gray-200">
        <thead class="bg-gray-50">
          <tr class="text-xs sm:text-sm">
            <th class="p-2 border text-center">
              <label for="selectAll" class="sr-only">انتخاب همه</label>
              <input type="checkbox" id="selectAll" aria-label="انتخاب همه">
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="1" onclick="sortByCol(this, 'userTable')">نام و نام خانوادگی
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <th class="p-2 border text-center hidden sm:table-cell">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="2" onclick="sortByCol(this, 'userTable')">نام کاربری
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="3" onclick="sortByCol(this, 'userTable')">نقش
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
            <th class="p-2 border text-center">
              <button type="button" class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center" data-col="4" onclick="sortByCol(this, 'userTable')">وضعیت
                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor"><path d="M10 14l-5-7h10l-5 7z"/></svg>
              </button>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr class="text-center border-b">
            <td class="p-2 border"><input type="checkbox" form="bulkForm" name="selected_users" value="{{ user.id }}" aria-label="انتخاب کاربر {{ user.username }}" {% if user.is_superuser %}disabled class="opacity-40 cursor-not-allowed"{% endif %}></td>
            <td class="p-0 border text-right nowrap">
              <a href="{% url 'users:user_edit' user.pk %}" class="block w-full h-full px-2 py-2 text-black hover:bg-cyan-300 focus:bg-cyan-300 rounded transition-colors duration-100 text-sm truncate-ellipsis">{{ user.full_name }}</a>
            </td>
            <td class="p-2 border hidden sm:table-cell nowrap">{{ user.username }}</td>
            <td class="p-2 border nowrap">
              <span class="px-2 py-1 rounded text-white truncate-ellipsis inline-block max-w-[8rem]
                {% if user.role == 'manager' %}bg-blue-600
                {% elif user.role == 'accountant' %}bg-amber-600
                {% elif user.role == 'seller' %}bg-purple-600
                {% elif user.role == 'cutter_master' %}bg-sky-600
                {% elif user.role == 'cnc_master' %}bg-indigo-600
                {% elif user.role == 'undercoating_master' %}bg-yellow-700
                {% elif user.role == 'painting_master' %}bg-rose-600
                {% elif user.role == 'assembly_master' %}bg-teal-600
                {% elif user.role == 'sewing_master' %}bg-fuchsia-600
                {% elif user.role == 'upholstery_master' %}bg-green-600
                {% elif user.role == 'packaging_master' %}bg-orange-600
                {% elif user.role == 'workpage_master' %}bg-lime-600
                {% else %}bg-gray-600{% endif %}">
                {{ user.get_role_display }}
              </span>
            </td>
            <td class="p-2 border nowrap">
              <button type="button" class="status-toggle text-sm px-2 py-1 rounded transition-colors duration-100 {% if user.is_active %}bg-green-200 text-green-700{% else %}bg-red-200 text-red-700{% endif %} {% if user.is_superuser %}opacity-40 cursor-not-allowed{% endif %}" data-url="{% url 'users:user_toggle' user.pk %}" data-active="{{ user.is_active|yesno:'true,false' }}" {% if user.is_superuser %}disabled aria-disabled="true"{% endif %}>
                {% if user.is_active %}فعال{% else %}غیرفعال{% endif %}
              </button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="5" class="p-4 text-center text-gray-500">کاربری یافت نشد.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- Stronger table borders; numbers will be bolded where present in cells -->
    <style>
      /* Stronger borders for better legibility */
      #userTable, #userTable th, #userTable td {
        border-color: rgba(0,0,0,0.38) !important;
        border-width: 1.5px;
      }
      #userTable thead th { border-bottom-width: 2px; }
    </style>
{# End content. #}

<script>
  // Sync XLSX export link with active filters
  document.addEventListener('DOMContentLoaded', function(){
    const exportBtn = document.getElementById('users_export_xlsx_btn');
    if (!exportBtn) return;
    const baseHref = exportBtn.getAttribute('data-base') || exportBtn.getAttribute('href') || '';
    function updateExportHref(){
      if (!baseHref) return;
      const params = new URLSearchParams();
      const roleSel = document.getElementById('roleFilter');
      const searchInput = document.getElementById('searchInput');
      if (roleSel && roleSel.value) params.set('role', roleSel.value);
      if (searchInput && searchInput.value) params.set('search', (searchInput.value || '').trim());
      const qs = params.toString();
      exportBtn.href = qs ? (baseHref + '?' + qs) : baseHref;
    }
    updateExportHref();
    const roleSel = document.getElementById('roleFilter');
    const searchInput = document.getElementById('searchInput');
    if (roleSel) roleSel.addEventListener('change', updateExportHref);
    if (searchInput) searchInput.addEventListener('input', updateExportHref);
  });
</script>

<script>
  // CSRF helper
  function getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return decodeURIComponent(parts.pop().split(';').shift());return null;}
  function setStatusUi(btn, active){btn.dataset.active=active?'true':'false';btn.textContent=active?'فعال':'غیرفعال';btn.classList.remove('bg-green-200','text-green-700','bg-red-200','text-red-700');if(active){btn.classList.add('bg-green-200','text-green-700');}else{btn.classList.add('bg-red-200','text-red-700');}}

  // Search
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.addEventListener('input', () => {
      const q = searchInput.value.trim().toLowerCase();
      document.querySelectorAll('#userTable tbody tr').forEach(tr => {
        const rowText = tr.textContent.trim().toLowerCase();
        tr.style.display = rowText.includes(q) ? '' : 'none';
      });
      updateDeleteState();
    });
  }

  // Bulk delete state
  function updateDeleteState(){const anyChecked=!!document.querySelector('#userTable tbody input[name="selected_users"]:checked');document.getElementById('bulkDeleteBtn').disabled=!anyChecked;}
  const selectAll=document.getElementById('selectAll');
  if(selectAll){selectAll.addEventListener('click',function(){document.querySelectorAll('#userTable tbody input[name="selected_users"]').forEach(cb=>{if(!cb.disabled)cb.checked=this.checked;});updateDeleteState();});}
  document.addEventListener('change',e=>{if(e.target&&e.target.name==='selected_users')updateDeleteState();});
  updateDeleteState();

  // AJAX status toggle
  document.addEventListener('click', async function (e) {
    const btn = e.target.closest('.status-toggle');
    if(!btn || btn.disabled) return;
    const url = btn.dataset.url; if(!url) return;
    const wasActive = btn.dataset.active === 'true';
    btn.disabled = true; setStatusUi(btn, !wasActive);
    try {
      const resp = await fetch(url, { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')||''} });
      if (![200,201,202,204,301,302].includes(resp.status)) setStatusUi(btn, wasActive);
    } catch(err){ setStatusUi(btn, wasActive); }
    finally { btn.disabled = false; }
  });

  // Simple sorter
  function sortByCol(btn, tableId){const colIdx=parseInt(btn.getAttribute('data-col'),10);const table=document.getElementById(tableId);if(!table)return;const tbody=table.querySelector('tbody');const rows=Array.from(tbody.querySelectorAll('tr'));const asc=!(btn.dataset.asc==='true');btn.dataset.asc=asc?'true':'false';rows.sort((a,b)=>{const ta=(a.children[colIdx]?.innerText||'').trim().toLowerCase();const tb=(b.children[colIdx]?.innerText||'').trim().toLowerCase();if(ta<tb)return asc?-1:1;if(ta>tb)return asc?1:-1;return 0;});rows.forEach(r=>tbody.appendChild(r));}
</script>
<script>
// Live-updating list status bar without altering Persian labels
(function(){
  function updateStatusBarFromDom(){
    try {
      const statusEl = document.getElementById('listStatus');
      if (!statusEl) return;
      const rows = Array.from(document.querySelectorAll('#userTable tbody tr'));
      const visibleRows = rows.filter(tr => tr && tr.style.display !== 'none');
      const total = visibleRows.length;
      let active = 0;
      for (const tr of visibleRows) {
        const btn = tr.querySelector('.status-toggle');
        if (btn && btn.dataset && btn.dataset.active === 'true') active++;
      }
      const parts = (statusEl.textContent || '').split('|');
      const numRe = /[0-9\u06F0-\u06F9\u0660-\u0669]+/g; // Latin + Persian/Arabic-Indic digits
      if (parts.length === 2) {
        const left = parts[0].replace(numRe, String(total)).trim();
        const right = parts[1].replace(numRe, String(active)).trim();
        statusEl.textContent = left + ' | ' + right;
      } else {
        statusEl.textContent = String(total) + ' | ' + String(active);
      }
    } catch (_) { /* no-op */ }
  }

  // Initial sync
  document.addEventListener('DOMContentLoaded', updateStatusBarFromDom);

  // Update on search typing
  document.addEventListener('input', function(e){
    if (e && e.target && e.target.id === 'searchInput') {
      // Allow the page's own filter logic to run first
      setTimeout(updateStatusBarFromDom, 0);
    }
  });

  // Update on status toggle changes: observe data-active and style mutations
  const table = document.getElementById('userTable');
  if (table && window.MutationObserver) {
    const observer = new MutationObserver(function(mutations){
      for (const m of mutations) {
        if (m.type === 'attributes' && (m.attributeName === 'data-active' || m.attributeName === 'style')) {
          updateStatusBarFromDom();
          break;
        }
      }
    });
    observer.observe(table, { attributes: true, attributeFilter: ['data-active','style'], subtree: true });
  }

  // Also catch clicks on toggle buttons (fallback for environments without MutationObserver)
  document.addEventListener('click', function(e){
    const btn = e.target && e.target.closest && e.target.closest('.status-toggle');
    if (btn) {
      // Update after UI change and after async completes
      setTimeout(updateStatusBarFromDom, 0);
      setTimeout(updateStatusBarFromDom, 350);
    }
  });
})();
</script>
{% endblock %}
