<!-- PATH: /Archen/orders/templates/orders/orders_list.html -->{% extends 'layout.html' %}{% load static %}{% load jalali_filters %}{% load status_badges %}{% block title %}لیست سفارش‌ها | آرچن{% endblock %}{% block page_title %}لیست سفارش‌ها{% endblock %}{% block back_button %}  <a href="{% url 'dashboard' %}"     class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-blue-600 text-blue-700 hover:bg-blue-200">بازگشت</a>{% endblock %}{% block Breadcrumb %}<!-- Breadcrumb --><div class="my-2 px-2 text-sm text-gray-600 rtl text-right breadcrumb">  <a href="{% url 'dashboard' %}" class="hover:underline">داشبورد</a>  <span class="mx-1">›</span>  <span class="text-gray-800 font-semibold">لیست سفارش‌ها</span></div>{% endblock %}{# Toolbar is rendered by layout.html. Remove local wrappers to avoid duplicate toolbar. #}
<style>
  #toolbar { flex-wrap: nowrap !important; }
  #toolbar #filtersForm { flex: 1 1 0%; min-width: 0; }
  #toolbar .flex-none { flex: 0 0 auto; }
</style>
    {% block list_toolbar_actions_right %}
      <a href="{% url 'orders:create' %}"
         class="flex-none inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-green-700 text-green-700 hover:bg-green-200">
        <svg class="w-4 h-4 ms-0 me-1 text-green-800" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        افزودن
      </a>
      <form id="bulkForm" method="post" action="{% url 'orders:bulk_delete' %}" class="flex-none">{% csrf_token %}
        <button id="bulkDeleteBtn" type="submit" class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-red-700 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <svg class="w-4 h-4 ms-0 me-1 text-red-700" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M9 3h6a1 1 0 0 1 1 1v1h3v2H5V5h3V4a1 1 0 0 1 1-1zm-2 6h10v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9zm2 2v8h2v-8H9zm4 0v8h2v-8h-2z"/></svg>
          حذف
        </button>
      </form>
    {% endblock %}
    {% block list_toolbar_filters %}
      <a id="orders_export_xlsx_btn"
         href="{% url 'orders:export_xlsx' %}"
         data-base="{% url 'orders:export_xlsx' %}"
         title="خروجی XLSX"
         class="flex-none inline-flex items-center h-8 px-3 text-xs whitespace-nowrap rounded border font-bold border-green-700 text-green-700 hover:bg-green-200 shrink-0">
        خروجی XLSX
      </a>
      <label for="statusFilter" class="sr-only">وضعیت</label>
      <select id="statusFilter" name="status" class="flex-none w-52 border border-gray-300 p-2 rounded text-sm bg-white" onchange="this.form.submit()" {% if orders|length == 0 %}disabled{% endif %}>
        <option value="">همه وضعیت‌ها</option>
        {% for val,label in status_choices %}
          <option value="{{ val }}" {% if current_status == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      <label for="searchInput" class="sr-only">جستجو</label>
      <input id="searchInput" type="text" name="search" value="{{ search_query }}" placeholder="جستجو..." class="flex-1 min-w-0 max-w-full border border-gray-300 p-2 rounded text-sm me-1" onkeydown="if(event.key==='Enter')this.form.submit()">
    {% endblock %}
{% block list_status %}سفارش‌ها: {{ orders|length }}{% endblock %}{% block content %}    <!-- Use header-like patterned surface for the list frame -->    <div class="overflow-x-auto surface-pattern surface-elevated rounded-xl p-2">      <!-- Prevent word wrapping on mobile; restore normal on >=sm -->      <span id="ordersTotal" data-total="{{ orders_total }}" class="hidden"></span><table id="ordersTable" class="min-w-full border border-gray-200 whitespace-nowrap sm:whitespace-normal" data-stage-seq="{{ stage_choices|join:'|' }}">        <thead class="bg-gray-50">          <tr class="text-xs sm:text-sm">            <th class="p-2 border text-center"><span class="sr-only">انتخاب</span></th>            <th class="p-2 border text-center">              <button type="button" class="sort-btn bg-transparent text-inherit text-xs sm:text-sm font-medium inline-flex items-center" data-col="1" onclick="sortByCol(this, 'ordersTable')">                شماره بیجک                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 14l-5-7h10l-5 7z"/></svg>              </button>            </th>            <th class="p-2 border text-center">              <button type="button" class="sort-btn bg-transparent text-inherit text-xs sm:text-sm font-medium inline-flex items-center" data-col="2" onclick="sortByCol(this, 'ordersTable')">                مشتری                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 14l-5-7h10l-5 7z"/></svg>              </button>            </th>            <th class="p-2 border text-center">              <button type="button" class="sort-btn bg-transparent text-inherit text-xs sm:text-sm font-medium inline-flex items-center" data-col="3" onclick="sortByCol(this, 'ordersTable')">                نام فروشگاه                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 14l-5-7h10l-5 7z"/></svg>              </button>            </th>            <th class="p-2 border text-center">              <button type="button" class="sort-btn bg-transparent text-inherit text-xs sm:text-sm font-medium inline-flex items-center" data-col="4" onclick="sortByColDate(this, 'ordersTable')">                تاریخ سفارش                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 14l-5-7h10l-5 7z"/></svg>              </button>            </th>            <th class="p-2 border text-center">              <button type="button" class="sort-btn bg-transparent text-inherit text-xs sm:text-sm font-medium inline-flex items-center" data-col="5" onclick="sortByCol(this, 'ordersTable')">                وضعیت                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 14l-5-7h10l-5 7z"/></svg>              </button>            </th>            <th class="p-2 border text-center">              <button type="button" class="sort-btn bg-transparent text-inherit text-xs sm:text-sm font-medium inline-flex items-center" data-col="6" onclick="sortByCol(this, 'ordersTable')">                مرحله فعلی                <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M10 14l-5-7h10l-5 7z"/></svg>              </button>            </th>          </tr>        </thead>        
        <tbody>
          {% for order in orders %}
          <tr class="text-center border-b order-row cursor-pointer" data-edit-url="{% url 'orders:edit' order.id %}">
            <td class="p-2 border">
              <input type="checkbox" form="bulkForm" name="selected_orders" value="{{ order.id }}" aria-label="select">
            </td>
            <td class="p-2 border badge-cell"><span class="font-bold">{{ order.badge_number }}</span></td>
            <td class="p-0 border">
              <div class="px-2 py-2 text-black text-sm">{{ order.customer_name }}</div>
            </td>
            <td class="p-2 border">{% if order.exhibition_name %}{{ order.exhibition_name }}{% else %}{{ order.store_name }}{% endif %}</td>
            <td class="p-2 border"><span class="font-bold">{{ order.order_date|to_jalali }}</span></td>
            <td class="p-2 border">
              {% with s=order.get_status_display %}
                {% with classes=s|order_status_classes %}
                  <span class="px-2 py-1 rounded {{ classes }}">{{ s }}</span>
                {% endwith %}
              {% endwith %}
            </td>
            <td class="p-2 border">
              <button type="button" class="stage-chip px-3 py-1 rounded border border-purple-200 bg-purple-50 text-purple-800 text-xs font-bold transition disabled:opacity-50" data-stage="{{ order.current_stage }}" data-endpoint="{% url 'orders:stage_update' order.id %}" title="برای رفتن به مرحله بعد کلیک کنید">
                {{ order.current_stage }}
              </button>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="p-4 text-center text-gray-500">سفارشی یافت نشد.</td></tr>
          {% endfor %}
        </tbody>
      </table>    </div>    <!-- Stronger table borders and bold numeric values (codes, dates) -->
    <style>
      /* Stronger borders for better legibility */
      #ordersTable, #ordersTable th, #ordersTable td {
        border-color: rgba(0,0,0,0.38) !important;
        border-width: 1.5px;
      }
      #ordersTable thead th { border-bottom-width: 2px; }
      #ordersTable tbody tr.order-row {
        transition: background-color .15s ease, box-shadow .15s ease;
      }
      #ordersTable tbody tr.order-row:hover,
      #ordersTable tbody tr.order-row:focus-within {
        background-color: rgba(191,219,254,0.45);
        box-shadow: inset 0 0 0 1px rgba(59,130,246,0.35);
      }
      .badge-cell {
        direction: ltr;
        text-align: center;
        font-feature-settings: "tnum";
        unicode-bidi: plaintext;
      }
      .stage-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        cursor: pointer;
        min-width: 110px;
      }
      .stage-chip--pending { opacity: 0.6; }
    </style>{# End of list content. #}<script>
const STAGE_SEQUENCE_FALLBACK = ['زیرکاری A','زیرکاری B','زیرکاری C','رنگ‌‌کاری','رویه‌کوبی','بسته‌بندی'];
let cachedCsrfToken = '';

function getCookie(name){
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  return null;
}

function readInlineCsrfToken(){
  const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
  return input && input.value ? input.value : '';
}

function ensureCsrfCookie(){
  const existing = getCookie('csrftoken');
  if (existing){
    cachedCsrfToken = existing;
    return existing;
  }
  const inlineToken = readInlineCsrfToken();
  if (inlineToken){
    document.cookie = `csrftoken=${inlineToken};path=/;SameSite=Lax`;
    cachedCsrfToken = inlineToken;
    return inlineToken;
  }
  return '';
}

function currentCsrfToken(){
  return getCookie('csrftoken') || cachedCsrfToken || ensureCsrfCookie();
}

document.addEventListener('DOMContentLoaded', ensureCsrfCookie);

// Live filtering: fetch the full page and swap only tbody + status bar
// Works without Enter on desktop and mobile keyboards
(function(){
  function debounce(fn, wait){ let t; return function(){ clearTimeout(t); t = setTimeout(fn.bind(this, ...arguments), wait); }; }
  function fetchAndSwap(){
    try {
      const tbody = document.querySelector('#ordersTable tbody');
      if (!tbody) return;
      const searchInput = document.getElementById('searchInput');
      const statusSel = document.getElementById('statusFilter');
      const params = new URLSearchParams();
      const q = (searchInput && searchInput.value ? searchInput.value : '').trim();
      if (q) params.set('search', q);
      if (statusSel && statusSel.value) params.set('status', statusSel.value);
      const url = window.location.pathname + (params.toString() ? ('?' + params.toString()) : '');
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.text())
        .then(html => {
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const newTbody = doc.querySelector('#ordersTable tbody');
          if (newTbody) {
            tbody.innerHTML = newTbody.innerHTML;
            if (typeof bindRowNavigation === 'function') {
              bindRowNavigation(tbody);
            }
          }
          // Update status bar: "سفارش‌ها: <total> | بعد از فیلتر: <filtered>"
          const statusHost = document.getElementById('listStatus');
          const totalEl = doc.getElementById('ordersTotal');
          const total = totalEl ? parseInt(totalEl.getAttribute('data-total') || totalEl.textContent || '0', 10) || 0 : 0;
          const filtered = newTbody ? newTbody.querySelectorAll('input[name="selected_orders"]').length : 0;
          if (statusHost) statusHost.textContent = 'سفارش‌ها: ' + String(total) + (((typeof q !== 'undefined' && q) || (searchInput && searchInput.value && searchInput.value.trim()) || (statusSel && statusSel.value)) ? ' | بعد از فیلتر: ' + String(filtered) : '');
          if (typeof updateDeleteState === 'function') updateDeleteState();
        })
        .catch(()=>{});
    } catch(_) {}
  }
  document.addEventListener('DOMContentLoaded', function(){
    const searchInput = document.getElementById('searchInput');
    const statusSel = document.getElementById('statusFilter');
    // Neutralize inline handlers so no form submit/enter is required
    try { if (statusSel) statusSel.onchange = null; } catch(_){ }
    try { if (searchInput) searchInput.onkeydown = null; } catch(_){ }
    const run = debounce(fetchAndSwap, 220);
    if (searchInput){ searchInput.addEventListener('input', run); searchInput.addEventListener('keyup', run); searchInput.addEventListener('change', run); }
    if (statusSel){ statusSel.addEventListener('change', fetchAndSwap); }
    // Initialize status bar text on first load
    try {
      const statusHost = document.getElementById('listStatus');
      const totalEl = document.getElementById('ordersTotal');
      const total = totalEl ? parseInt(totalEl.getAttribute('data-total') || totalEl.textContent || '0', 10) || 0 : 0;
      const filtered = document.querySelectorAll('#ordersTable tbody input[name="selected_orders"]').length;
      if (statusHost) statusHost.textContent = 'سفارش‌ها: ' + String(total) + (((typeof q !== 'undefined' && q) || (searchInput && searchInput.value && searchInput.value.trim()) || (statusSel && statusSel.value)) ? ' | بعد از فیلتر: ' + String(filtered) : '');
    } catch(_) {}
  });
})();

// Bulk selection state
function updateDeleteState(){
  const any = !!document.querySelector('#ordersTable tbody input[name="selected_orders"]:checked');
  const btn = document.getElementById('bulkDeleteBtn');
  if (btn) btn.disabled = !any;
}
const selectAll = document.getElementById('selectAll');
if (selectAll){
  selectAll.addEventListener('click', function(){
    document.querySelectorAll('#ordersTable tbody input[name="selected_orders"]').forEach(cb => cb.checked = this.checked);
    updateDeleteState();
  });
}
document.addEventListener('change', e => { if (e.target && e.target.name === 'selected_orders') updateDeleteState(); });

// Stage chip helpers
function getStageSequence(){
  var table = document.getElementById('ordersTable');
  if (!table) return STAGE_SEQUENCE_FALLBACK.slice();
  var raw = table.getAttribute('data-stage-seq') || '';
  var seq = raw.split('|').map(function(item){ return item.trim(); }).filter(function(item){ return !!item; });
  return seq.length ? seq : STAGE_SEQUENCE_FALLBACK.slice();
}
function applyStageUi(btn, stage, pending){
  if (!btn) return;
  btn.dataset.stage = stage || '';
  btn.textContent = stage || '---';
  if (pending) btn.classList.add('stage-chip--pending');
  else btn.classList.remove('stage-chip--pending');
}

document.addEventListener('click', async function(e){
  var btn = e.target && e.target.closest ? e.target.closest('.stage-chip') : null;
  if (!btn) return;
  e.preventDefault();
  if (btn.disabled) return;
  var seq = getStageSequence();
  if (!seq.length) return;
  var current = btn.dataset.stage && seq.indexOf(btn.dataset.stage) !== -1 ? btn.dataset.stage : seq[0];
  var next = seq[(seq.indexOf(current) + 1) % seq.length];
  var endpoint = btn.dataset.endpoint;
  if (!endpoint) return;
  var previous = current;
  btn.disabled = true;
  applyStageUi(btn, next, true);
  var csrfToken = currentCsrfToken();
  try {
    var resp = await fetch(endpoint, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken || ''
      },
      body: JSON.stringify({ stage: next })
    });
    if (!resp.ok) throw new Error('bad status');
    var data = await resp.json().catch(function(){ return {}; });
    var confirmed = data && typeof data.stage === 'string' && seq.indexOf(data.stage) !== -1 ? data.stage : next;
    applyStageUi(btn, confirmed, false);
  } catch (err) {
    applyStageUi(btn, previous, false);
  } finally {
    btn.disabled = false;
  }
});

function bindRowNavigation(scope){
  var root = scope || document;
  var rows = root.querySelectorAll ? root.querySelectorAll('#ordersTable tbody tr.order-row') : [];
  rows.forEach(function(row){
    if (row.__ordersRowNavBound) return;
    row.__ordersRowNavBound = true;
    row.addEventListener('click', function(ev){
      if (ev.defaultPrevented) return;
      if (ev.target.closest && ev.target.closest('button, a, input, label, .stage-chip')) return;
      var url = row.getAttribute('data-edit-url');
      if (url) {
        window.location.href = url;
      }
    });
  });
}

document.addEventListener('DOMContentLoaded', function(){
  bindRowNavigation(document);
});

function sortByColDate(btn, tableId){
  if (!btn) return;
  const colIdx = parseInt(btn.getAttribute('data-col'), 10);
  const table = tableId ? document.getElementById(tableId) : btn.closest('table');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  if (!tbody) return;

  const rows = Array.from(tbody.querySelectorAll('tr')).filter(function (r) {
    return !!r.querySelector('td');
  });

  // Keep sort state compatible with global sorter
  window.__sortState = window.__sortState || {};
  const key = (table.id || 'table') + ':' + String(colIdx);
  const nextDir = window.__sortState[key] === 'asc' ? 'desc' : 'asc';
  window.__sortState[key] = nextDir;
  const asc = nextDir === 'asc';

  // Toggle data attribute for any legacy consumers
  btn.closest('thead').querySelectorAll('.sort-btn').forEach(function (b) {
    if (b !== btn) {
      b.dataset.asc = '';
    }
  });
  btn.dataset.asc = asc ? 'true' : 'false';

  function toAsciiDigits(str){
    if (!str) return '';
    const map = {
      '۰':'0','۱':'1','۲':'2','۳':'3','۴':'4','۵':'5','۶':'6','۷':'7','۸':'8','۹':'9',
      '٠':'0','١':'1','٢':'2','٣':'3','٤':'4','٥':'5','٦':'6','٧':'7','٨':'8','٩':'9'
    };
    return String(str).split('').map(function(ch){ return map[ch] || ch; }).join('');
  }

  function parseJalali(s){
    const txt = toAsciiDigits((s || '').trim());
    const m = txt.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
    if (!m) return 0;
    return parseInt(
      m[1].padStart(4, '0') +
      m[2].padStart(2, '0') +
      m[3].padStart(2, '0'),
      10
    );
  }

  rows
    .sort(function (a, b) {
      const ta = parseJalali(a.children[colIdx] ? a.children[colIdx].innerText : '');
      const tb = parseJalali(b.children[colIdx] ? b.children[colIdx].innerText : '');
      if (ta < tb) return asc ? -1 : 1;
      if (ta > tb) return asc ? 1 : -1;
      return 0;
    })
    .forEach(function (r) { tbody.appendChild(r); });

  // Mirror visual arrow behaviour from global sorter
  table.querySelectorAll('thead .sort-btn').forEach(function (b) {
    b.classList.remove('text-blue-700', 'font-semibold');
    const ic = b.querySelector('.sort-indicator');
    if (ic) {
      ic.classList.remove('opacity-100', 'rotate-180');
      ic.classList.add('opacity-40');
    }
  });

  btn.classList.add('text-blue-700', 'font-semibold');
  const icon = btn.querySelector('.sort-indicator');
  if (icon) {
    icon.classList.remove('opacity-40');
    icon.classList.add('opacity-100');
    if (asc) icon.classList.add('rotate-180');
    else icon.classList.remove('rotate-180');
  }
}

// Header select-all injection: render checkbox in the first header cell
// Existing handlers below already listen to #selectAll and row changes.
document.addEventListener('DOMContentLoaded', function(){
  var table = document.getElementById('ordersTable');
  if (!table) return;
  var firstTh = table.querySelector('thead th:first-child');
  if (firstTh && !firstTh.querySelector('input[type="checkbox"]')) {
    firstTh.innerHTML = '<input type="checkbox" id="selectAll" aria-label="انتخاب همه">';
  }
  // Bind click handler to the injected checkbox to toggle all rows
  var sa = document.getElementById('selectAll');
  if (sa && !sa.dataset.bound) {
    sa.addEventListener('click', function(){
      document.querySelectorAll('#ordersTable tbody input[name="selected_orders"]').forEach(function(cb){ cb.checked = sa.checked; });
      if (typeof updateDeleteState === 'function') updateDeleteState();
    });
    sa.dataset.bound = '1';
  }
});

document.addEventListener('DOMContentLoaded', function(){
  var exportBtn = document.getElementById('orders_export_xlsx_btn');
  if (!exportBtn) return;
  var baseHref = exportBtn.getAttribute('data-base') || exportBtn.getAttribute('href') || '';
  function updateExportHref(){
    if (!baseHref) return;
    var params = new URLSearchParams();
    var statusSelect = document.getElementById('statusFilter');
    var searchInput = document.getElementById('searchInput');
    if (statusSelect && statusSelect.value) params.set('status', statusSelect.value);
    if (searchInput && searchInput.value) params.set('search', searchInput.value.trim());
    var qs = params.toString();
    exportBtn.href = qs ? baseHref + '?' + qs : baseHref;
  }
  updateExportHref();
  var statusSelect = document.getElementById('statusFilter');
  var searchInput = document.getElementById('searchInput');
  if (statusSelect) statusSelect.addEventListener('change', updateExportHref);
  if (searchInput) searchInput.addEventListener('input', updateExportHref);
});

</script>{% endblock %}
