{% extends 'layout.html' %}
{% load static %}
{% load jalali_filters %}

{% block title %}لیست کارها | صنایع چوبی آرچن{% endblock %}
{% block page_title %}لیست کارها{% endblock %}

{% block back_button %}
  <a href="{% url 'dashboard' %}"
     class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-blue-600 text-blue-700 hover:bg-blue-200">
    بازگشت
  </a>
{% endblock %}

{% block Breadcrumb %}
<!-- Breadcrumb: Dashboard › Job List -->
<div class="my-2 px-2 text-sm text-gray-600 rtl text-right breadcrumb">
  <a href="{% url 'dashboard' %}" class="hover:underline">داشبورد</a>
  <span class="mx-1">›</span>
  <span class="text-gray-800 font-semibold">لیست کارها</span>
</div>
{% endblock %}

{# Toolbar is global in layout; avoid local wrappers here. #}
{% block list_toolbar_actions_right %}
  <a href="{% url 'jobs:job_add' %}"
     class="flex-none inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-green-700 text-green-700 hover:bg-green-200">
    <svg class="w-4 h-4 ms-0 me-1 text-green-800" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
    </svg>
    افزودن
  </a>
  <form id="bulkForm" method="post" action="{% url 'jobs:job_bulk_delete' %}" class="flex-none">
    {% csrf_token %}
    <button id="bulkDeleteBtn" type="submit"
            class="inline-flex items-center px-2 py-1 text-sm font-bold rounded border border-red-700 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
      <svg class="w-4 h-4 ms-0 me-1 text-red-700" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M9 3h6a1 1 0 0 1 1 1v1h3v2H5V5h3V4a1 1 0 0 1 1-1zm-2 6h10v10a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2V9zm2 2v8h2v-8H9zm4 0v8h2v-8h-2z" />
      </svg>
      حذف
    </button>
  </form>
{% endblock %}

{% block list_toolbar_filters %}
  <a id="jobs_export_xlsx_btn"
     href="{% url 'jobs:export_xlsx' %}"
     data-base="{% url 'jobs:export_xlsx' %}"
     title="خروجی XLSX"
         class="flex-none inline-flex items-center h-8 px-3 text-xs whitespace-nowrap rounded border font-bold border-green-700 text-green-700 hover:bg-green-200 shrink-0">
    خروجی XLSX
  </a>
  <label for="labelFilter" class="sr-only">وضعیت</label>
  <select id="labelFilter" name="label"
          class="flex-none w-44 border border-gray-300 p-2 rounded text-sm bg-white">
    <option value="">همه وضعیت‌ها</option>
    {% for value, label in label_choices %}
      <option value="{{ value }}" {% if current_label == value %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <label for="searchInput" class="sr-only">جستجو</label>
  <input id="searchInput" type="text" name="search" value="{{ search_query }}" placeholder="جستجو..."
         class="flex-1 min-w-0 max-w-full border border-gray-300 p-2 rounded text-sm me-1">
{% endblock %}

{% block list_status %}کارها: {{ jobs|length }} | فعال: {{ active_jobs_count }}{% endblock %}

{% block content %}
<!-- Use header-like patterned surface for the list frame -->
<div class="overflow-x-auto surface-pattern surface-elevated rounded-xl p-2">
  <style>
    /* Force LTR for YYYY-MM-DD and HH:mm in RTL tables */
    .num-ltr { direction: ltr; unicode-bidi: isolate; display: inline-block; }
    /* Row highlight similar to orders list */
    #jobTable tbody tr.job-row {
      transition: background-color .15s ease, box-shadow .15s ease;
      cursor: pointer;
    }
    #jobTable tbody tr.job-row:hover,
    #jobTable tbody tr.job-row:focus-within {
      background-color: rgba(191,219,254,0.45);
      box-shadow: inset 0 0 0 1px rgba(59,130,246,0.35);
    }
  </style>

  <!-- Prevent word wrapping on mobile; restore normal on >=sm -->
  <span id="jobsTotal"
        data-total="{{ jobs_total|default:jobs|length }}"
        data-total-all="{{ jobs_total_all|default:jobs_total|default:jobs|length }}"
        class="hidden"></span>

  <table id="jobTable" class="min-w-full border border-gray-200 whitespace-nowrap sm:whitespace-normal">
    <thead class="bg-gray-50">
      <tr class="text-xs sm:text-sm">
        <th class="p-2 border text-center hidden sm:table-cell">
          <label for="selectAll" class="sr-only">انتخاب همه</label>
          <input type="checkbox" id="selectAll" aria-label="انتخاب همه">
        </th>
        <th class="p-2 border text-center">
          <button type="button"
                  class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                  data-col="1"
                  data-type="num"
                  onclick="sortByCol(this, 'jobTable')">
            شماره کار
            <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150"
                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M10 14l-5-7h10l-5 7z"/>
            </svg>
          </button>
        </th>
        <th class="p-2 border text-center">
          <button type="button"
                  class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                  data-col="2"
                  onclick="sortByCol(this, 'jobTable')">
            وضعیت
            <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150"
                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M10 14l-5-7h10l-5 7z"/>
            </svg>
          </button>
        </th>
        <th class="p-2 border text-center">
          <button type="button"
                  class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                  data-col="3"
                  onclick="sortByCol(this, 'jobTable')">
            مدل
            <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150"
                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M10 14l-5-7h10l-5 7z"/>
            </svg>
          </button>
        </th>
        <th class="p-2 border text-center">
          <button type="button"
                  class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                  data-col="4"
                  onclick="sortByCol(this, 'jobTable')">
            محصول
            <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150"
                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M10 14l-5-7h10l-5 7z"/>
            </svg>
          </button>
        </th>
        <th class="p-2 border text-center">
          <button type="button"
                  class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                  data-col="5"
                  onclick="sortByCol(this, 'jobTable')">
            تاریخ ایجاد
            <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150"
                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M10 14l-5-7h10l-5 7z"/>
            </svg>
          </button>
        </th>
        <th class="p-2 border text-center">
          <button type="button"
                  class="sort-btn bg-transparent text-inherit text-sm font-medium inline-flex items-center"
                  data-col="6"
                  onclick="sortByCol(this, 'jobTable')">
            تاریخ بسته شدن
            <svg class="sort-indicator ms-1 w-3 h-3 text-gray-500 opacity-40 transition-all duration-150"
                 viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M10 14l-5-7h10l-5 7z"/>
            </svg>
          </button>
        </th>
      </tr>
    </thead>
    <tbody>
      {% for job in jobs %}
      <tr class="text-center border-b job-row cursor-pointer" data-edit-url="{% url 'jobs:job_edit' job.pk %}">
        <td class="p-2 border hidden sm:table-cell">
          <input type="checkbox" form="bulkForm" name="ids" value="{{ job.id }}"
                 aria-label="انتخاب کار {{ job.job_number }}">
        </td>
        <td class="p-0 border">
          <a href="{% url 'jobs:job_edit' job.pk %}"
             class="block w-full h-full px-2 py-2 text-black rounded transition-colors duration-100 text-sm">
            <span class="font-bold">{{ job.job_number }}</span>
          </a>
        </td>
        <td class="p-2 border">
          {% if job.job_label == 'in_progress' %}
            <span class="px-2 py-1 rounded text-white bg-gray-500 text-xs sm:text-sm">در حال ساخت</span>
          {% elif job.job_label == 'completed' %}
            <span class="px-2 py-1 rounded text-white bg-green-400 text-xs sm:text-sm">تولید شده</span>
          {% elif job.job_label == 'scrapped' %}
            <span class="px-2 py-1 rounded text-white bg-red-600 text-xs sm:text-sm">اسقاط</span>
          {% elif job.job_label == 'warranty' %}
            <span class="px-2 py-1 rounded text-black bg-yellow-300 text-xs sm:text-sm">گارانتی</span>
          {% elif job.job_label == 'repaired' %}
            <span class="px-2 py-1 rounded text-white bg-blue-600 text-xs sm:text-sm">تعمیرات</span>
          {% elif job.job_label == 'deposit' %}
            <span class="px-2 py-1 rounded text-white" style="background-color:#8B4513">امانی</span>
          {% else %}
            <span class="px-2 py-1 rounded text-white bg-gray-400 text-xs sm:text-sm">{{ job.get_job_label_display }}</span>
          {% endif %}
        </td>
        <td class="p-2 border">
          {% if job.product and job.product.product_model %}
            {{ job.product.product_model.name }}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="p-2 border">
          {% if job.product %}
            {{ job.product.name }}
          {% else %}
            -
          {% endif %}
        </td>
        <td class="p-2 border">
          <span class="num-ltr font-bold">{{ job.created_at|to_jalali }}</span>
        </td>
        <td class="p-2 border">
          {% if job.finished_at %}
            <span class="num-ltr font-bold">{{ job.finished_at|to_jalali }}</span>
          {% else %}
            -
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" class="p-4 text-center text-gray-500">کاری یافت نشد.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Stronger table borders and bold numeric values (job number, dates) -->
<style>
  #jobTable,
  #jobTable th,
  #jobTable td {
    border-color: rgba(0,0,0,0.38) !important;
    border-width: 1.5px;
  }
  #jobTable thead th { border-bottom-width: 2px; }
</style>

<script>
// AJAX refresh for search/filters: fetch and replace table only
(function(){
  function debounce(fn, wait){ let t; return function(){ clearTimeout(t); t=setTimeout(fn.bind(this, ...arguments), wait); }; }
  // Convert Persian/Arabic-Indic digits to ASCII for safe parseInt
  function toAsciiDigits(str){
    if(!str) return '';
    return String(str)
      .replace(/[\u06F0-\u06F9]/g, d=>String(d.charCodeAt(0)-0x06F0))
      .replace(/[\u0660-\u0669]/g, d=>String(d.charCodeAt(0)-0x0660));
  }
  // Global sticky total of all jobs (unfiltered)
  if(typeof window.JOBS_TOTAL_ALL === 'undefined') window.JOBS_TOTAL_ALL = 0;
  function fetchAndSwap(){
    try{
      const tbody=document.querySelector('#jobTable tbody'); if(!tbody) return;
      const searchInput=document.getElementById('searchInput');
      const labelSel=document.getElementById('labelFilter');
      const params=new URLSearchParams();
      const q=(searchInput&&searchInput.value?searchInput.value:'').trim();
      if(q) params.set('search', q);
      if(labelSel && labelSel.value) params.set('label', labelSel.value);
      const url=window.location.pathname + (params.toString()?('?'+params.toString()):'');
      fetch(url,{headers:{'X-Requested-With':'XMLHttpRequest'}})
        .then(r=>r.text())
        .then(html=>{
          const doc=new DOMParser().parseFromString(html,'text/html');
          const newTbody=doc.querySelector('#jobTable tbody');
          if(newTbody){
            tbody.innerHTML=newTbody.innerHTML;
            if(typeof bindJobRowNavigation === 'function'){
              bindJobRowNavigation(document);
            }
          }
          const statusHost=document.getElementById('listStatus');
          const hostTotalEl=document.getElementById('jobsTotal');
          const incomingTotalEl=doc.getElementById('jobsTotal');
          const filtered=newTbody?newTbody.querySelectorAll('tr').length:0;
          const filteredActive=!!q || !!(labelSel && labelSel.value);
          // Try to read total-all from incoming; if valid, persist globally + DOM
          let incomingAll = incomingTotalEl ? parseInt(toAsciiDigits(incomingTotalEl.getAttribute('data-total-all')||incomingTotalEl.getAttribute('data-total')||incomingTotalEl.textContent||'0'),10)||0 : 0;
          if(incomingAll>0){ window.JOBS_TOTAL_ALL = incomingAll; }
          // If still not set, try host DOM
          if(!window.JOBS_TOTAL_ALL && hostTotalEl){
            const hostAll = parseInt(toAsciiDigits(hostTotalEl.getAttribute('data-total-all')||hostTotalEl.getAttribute('data-total')||hostTotalEl.textContent||'0'),10)||0;
            if(hostAll>0) window.JOBS_TOTAL_ALL = hostAll;
          }
          // As a last resort, if everything failed but we have rows, use filtered as a temporary stand-in
          if(!window.JOBS_TOTAL_ALL && filtered>0){ window.JOBS_TOTAL_ALL = filtered; }
          // Sync DOM holder whenever we have a positive total-all
          if(hostTotalEl && window.JOBS_TOTAL_ALL>0){
            hostTotalEl.setAttribute('data-total-all', String(window.JOBS_TOTAL_ALL));
            hostTotalEl.setAttribute('data-total', String(window.JOBS_TOTAL_ALL));
            hostTotalEl.textContent=String(window.JOBS_TOTAL_ALL);
          }
          // Update status text: show totalAll and filtered count when filters are active
          if(statusHost){
            let txt='کارها: '+String(window.JOBS_TOTAL_ALL||0);
            if(filteredActive) txt+=' | نتایج فیلتر: '+String(filtered);
            statusHost.textContent=txt;
          }
          updateDeleteState();
        })
        .catch(()=>{});
    }catch(_){ }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const searchInput=document.getElementById('searchInput');
    const labelSel=document.getElementById('labelFilter');
    try{ if(labelSel) labelSel.onchange=null; }catch(_){ }
    try{ if(searchInput) searchInput.onkeydown=null; }catch(_){ }
    const run=debounce(fetchAndSwap,220);
    if(searchInput){
      searchInput.addEventListener('input',run);
      searchInput.addEventListener('keyup',run);
      searchInput.addEventListener('change',run);
    }
    if(labelSel){ labelSel.addEventListener('change', fetchAndSwap); }
    if(typeof bindJobRowNavigation === 'function'){
      bindJobRowNavigation(document);
    }
    // Initialize status text on initial page load
    try{
      const statusHost=document.getElementById('listStatus');
      const totalEl=document.getElementById('jobsTotal');
      const filtered=document.querySelectorAll('#jobTable tbody tr').length;
      // Initialize global from DOM holder
      if(totalEl){
        const initAll = parseInt(toAsciiDigits(totalEl.getAttribute('data-total-all')||totalEl.getAttribute('data-total')||totalEl.textContent||'0'),10)||0;
        if(initAll>0) window.JOBS_TOTAL_ALL = initAll;
      }
      if(!window.JOBS_TOTAL_ALL && filtered>0){
        window.JOBS_TOTAL_ALL = filtered;
        if(totalEl){
          totalEl.setAttribute('data-total-all', String(window.JOBS_TOTAL_ALL));
          totalEl.setAttribute('data-total', String(window.JOBS_TOTAL_ALL));
          totalEl.textContent = String(window.JOBS_TOTAL_ALL);
        }
      }
      const q0=(searchInput&&searchInput.value?searchInput.value:'').trim();
      const l0=(labelSel&&labelSel.value)||'';
      const filteredActive0=!!q0 || !!l0;
      // Same status text logic as in fetch path
      if(statusHost){
        let txt='کارها: '+String(window.JOBS_TOTAL_ALL||0);
        if(filteredActive0) txt+=' | نتایج فیلتر: '+String(filtered);
        statusHost.textContent=txt;
      }
    }catch(_){ }
  });
})();

// Update bulk delete button enabled/disabled state
function updateDeleteState(){
  const anyChecked=!!document.querySelector('#jobTable tbody input[name="ids"]:checked');
  const btn=document.getElementById('bulkDeleteBtn');
  if(btn) btn.disabled=!anyChecked;
}

// Make each job row navigate to its edit page when clicking empty space
function bindJobRowNavigation(scope){
  const root = scope && scope.querySelectorAll ? scope : document;
  const selector = root === document || root.nodeType === 9 ? '#jobTable tbody tr.job-row' : 'tr.job-row';
  const rows = root.querySelectorAll ? root.querySelectorAll(selector) : [];
  rows.forEach(row => {
    if(row.__jobRowNavBound) return;
    row.__jobRowNavBound = true;
    row.addEventListener('click', ev => {
      if(ev.defaultPrevented) return;
      if(ev.target.closest && ev.target.closest('a, button, input, label, select, textarea')) return;
      const url = row.getAttribute('data-edit-url');
      if(url){
        window.location.href = url;
      }
    });
  });
}

const selectAll=document.getElementById('selectAll');
if(selectAll){
  selectAll.addEventListener('click',function(){
    document.querySelectorAll('#jobTable tbody input[name="ids"]').forEach(cb=>cb.checked=this.checked);
    updateDeleteState();
  });
}
document.addEventListener('change',e=>{
  if(e.target && e.target.name==='ids') updateDeleteState();
});
updateDeleteState();

// Fix garbled Persian texts injected earlier due to encoding
document.addEventListener('DOMContentLoaded', function(){
  try{
    const lbl=document.querySelector('label[for="searchInput"].sr-only');
    if(lbl) lbl.textContent='جستجو';
    const inp=document.getElementById('searchInput');
    if(inp) inp.setAttribute('placeholder','جستجو...');
  }catch(_){ }
});

// Update XLSX export link to reflect current filters
document.addEventListener('DOMContentLoaded', function(){
  const exportBtn = document.getElementById('jobs_export_xlsx_btn');
  if (!exportBtn) return;
  const baseHref = exportBtn.getAttribute('data-base') || exportBtn.getAttribute('href') || '';
  function updateExportHref(){
    if (!baseHref) return;
    const params = new URLSearchParams();
    const labelSel = document.getElementById('labelFilter');
    const searchInput = document.getElementById('searchInput');
    if (labelSel && labelSel.value) params.set('label', labelSel.value);
    if (searchInput && searchInput.value) params.set('search', (searchInput.value || '').trim());
    const qs = params.toString();
    exportBtn.href = qs ? (baseHref + '?' + qs) : baseHref;
  }
  updateExportHref();
  const labelSel = document.getElementById('labelFilter');
  const searchInput = document.getElementById('searchInput');
  if (labelSel) labelSel.addEventListener('change', updateExportHref);
  if (searchInput) searchInput.addEventListener('input', updateExportHref);
});
</script>
{% endblock %}
